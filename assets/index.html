<!DOCTYPE html>
<html lang="en" x-data="moechat">
<head>
    <meta charset="UTF-8">
    <title>MoeChat</title>
    <link rel="icon" type="image/jpg" href="/assets/img/default-avatar.png" />
    <script type="text/javascript" src="/assets/js/alpine.min.js" defer></script>
    <script type="text/javascript" src="/assets/js/XhrSource.js" defer></script>
    <script type="text/javascript" src="/assets/js/marked.min.js" defer></script>
    <link rel="stylesheet" href="/assets/css/tiny.tailwind.css">
    <script src="/assets/js/http_cdn.jsdelivr.net_npm_@unocss_runtime_attributify.global.js" defer></script>

</head>
<body flex overflow-hidden h-screen m-0>
    <aside x-init="devFetch($el)" x-show="menuShow" flex flex-col w-15% justify-between bg-gray-50>
        {{template "aside.html"}}
    </aside>
    <main x-init="devFetch($el)" flex flex-col flex-auto>
        {{template "main.html"}}
    </main>
</body>
<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('moechat', () => ({
            async init() {
                await this.chats.post();
                await this.chat.post();
                await this.user.post();
            },
            async devFetch(el){
                let xText=el.innerText
                if (xText.includes('{') && xText.includes('}')) {
                    el.innerHTML= await (await fetch(xText.split('"')[1])).text()
                }
            },

            chat:{
                data:{
                    messages: [],
                },
                async post(url = ''){
                    let res =await (await fetch(url, { method: 'POST' })).json();
                    history.replaceState(null, '', url);
                    this.data=res
                    return res
                },
                async put(body){
                    let res =await (await fetch(``, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(body)
                    })).json()
                    return res
                },
            },
            chats: {
                data:[],
                async post(){
                    this.data = (await (await fetch('/chats', { method: 'POST' })).json()) || [];
                },
            },
            files:{
                messages:[],
                async post(){
                    this.messages = (await (await fetch('/file', { method: 'POST' ,body: new FormData(event.target.form)})).json()) || [];
                    event.target.form.reset()
                }
            },
            user:{
                data:{},
                show:false,
                async post(){
                    this.data = (await (await fetch('/user', { method: 'POST' })).json()) || {};
                }
            },
            menuShow:true,
            chatSettingShow:false,
            ProviderModel: "",//下拉菜单的绑定，服务端不用
            systemPrompt:"",//prompt
            userContent: {
                systemPrompt:"",
                max_tokens:4096,//上下文长度
                temperature:0.7,//温度
                topk:40,//topk
                topp:0.9,//topp
                'x-ref': 'userContent',
                '@keydown.enter'(event) {
                    const textarea = this.$refs.userContent;
                    if (!event.shiftKey) {
                        event.preventDefault()
                        if (this.systemPrompt!=="" && this.chat.data.messages[0].role !== "system") {
                            // Add system prompt as the first message in msgs
                            this.chat.data.messages.unshift({ role: "system", content: this.systemPrompt });
                        }
                        if (this.files.messages.length>0){
                            this.chat.data.messages.push({ content: "", role: "user" ,files:this.files.messages});
                            this.files.messages=[]
                        }
                        this.chat.data.messages.push({ content: textarea.value, role: "user" });
                        textarea.value = '';
                        this.postCompletion();
                    }
                },
                '@input'(){
                    const textarea = this.$refs.userContent;
                    textarea.style.height = 'auto'; // 重置高度
                    const computed = window.getComputedStyle(textarea); // Get computed styles
                    const padding = parseFloat(computed.paddingTop) + parseFloat(computed.paddingBottom); // Calculate vertical padding
                    const border = parseFloat(computed.borderTopWidth) + parseFloat(computed.borderBottomWidth); // Calculate border widths
                    textarea.style.height = textarea.scrollHeight - padding - border + 'px'; // Adjust based on actual content height
                }
            },
            async postCompletion(){
                let chatForm={
                    provider : this.ProviderModel.split(':')[0], // 冒号前的部分
                    model :this.ProviderModel.split(':').slice(1).join(':'),// 冒号后的部分
                    messages: this.chat.data.messages,
                    max_tokens:this.userContent.max_tokens,//上下文长度
                    temperature:this.userContent.temperature,//温度
                    topk:this.userContent.topk,//topk
                    topp:this.userContent.topp,//topp
                }
                const xs = XhrSource('/chat/completion', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body:  JSON.stringify(chatForm)
                });
                xs.addEventListener('open', () => {
                    this.chat.data.messages.push({content: '', role: "assistant"});
                });
                xs.addEventListener('message', e => {
                    // 获取当前messages中的最后一条消息
                    const messages = this.chat.data.messages;
                    const lastMessage = messages[messages.length - 1];
                    // 将接收到的数据追加到最后一条消息的content中
                    if (lastMessage && lastMessage.role === "assistant") {
                        lastMessage.content += JSON.parse(e.data);
                        // window.hljs.highlightAll();
                    }
                });
                xs.addEventListener('close', async e => {
                    //流式响应结束后在这put /chat
                    let res=await this.chat.put(this.chat.data)
                    history.replaceState(null, '', `/chat/${res.id}`);
                    console.log(`SSE connection closed,replaced history with ${res.id}`);
                    await this.chats.post()
                });
            }
        }))
    })
</script>