<!DOCTYPE html>
<html lang="en" x-data="moechat">
<head>
    <meta charset="UTF-8">
    <title>MoeChat</title>
    <link rel="icon" type="image/jpg" href="/assets/img/favicon.jpg" />
    <script type="text/javascript" src="/assets/js/alpine.min.js" defer></script>
    <script type="text/javascript" src="/assets/js/XhrSource.js" defer></script>
    <script type="text/javascript" src="/assets/js/marked.min.js" defer></script>
    <link rel="stylesheet" href="/assets/css/pico.purple.min.css">
    <link rel="stylesheet" href="/assets/css/tiny.tailwind.css">
    <style>
        [data-theme=light],
        :root:not([data-theme=dark]) {
            --pico-accordion-active-summary-color: #0009;
            --pico-text-selection-color: #E7B6EE33;
            --pico-primary: #943DA5;
            --pico-font-family-sans-serif: Inter, system-ui, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, Helvetica, Arial, "Helvetica Neue", sans-serif, var(--pico-font-family-emoji);
            --pico-font-size: 95%;
            /* Original: 100% */
            --pico-line-height: 1.1;
            /* Original: 1.5 */
            --pico-form-element-spacing-vertical: 0.5rem;
            /* Original: 1rem */
            --pico-form-element-spacing-horizontal: 1.0rem;
            /* Original: 1.25rem */
            --pico-border-radius: 0rem;
            /* Original: 0.25rem */
            --pico-block-spacing-vertical: 0;
            /* Original: 1rem */
        }

        body {
            margin: 0;
            padding: 0;
            height: 100vh;
        }

        aside {
            background-color: rgba(66, 54, 235, 0.2);

        }

        main {
            & header{
                & details{
                    margin-bottom: 0;
                }
            }
        }
    </style>
</head>
<body class="flex-row overflow-hidden">
    <aside class="flex-1 flex-col justify-between"  x-init="devFetch($el)" x-show="menuShow">
        {{template "aside.html"}}
    </aside>
    <main class="flex-5 flex-col justify-between h-screen"  x-init="devFetch($el)">
        {{template "main.html"}}
    </main>
</body>
<!--<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/styles/default.min.css">-->
<!--<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>-->
<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('moechat', () => ({
            async init() {
                await this.chats.post();
                await this.chat.post();
            },
            async devFetch(el){
                let xText=el.innerText
                if (xText.includes('{') && xText.includes('}')) {
                    el.innerHTML= await (await fetch(xText.split('"')[1])).text()
                }
            },
            max_tokens:4096,//上下文长度
            temperature:0.7,//温度
            topk:40,//topk
            topp:0.9,//topp
            chat:{
                data:{
                    messages: [],
                },
                async post(url = ''){
                    let res =await (await fetch(url, { method: 'POST' })).json();
                    history.replaceState(null, '', url);
                    this.data=res
                    return res
                },
                async put(body){
                    let res =await (await fetch(``, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(body)
                    })).json()
                    return res
                },
            },
            chats: {
                data:[],
                async post(){
                    this.data = (await (await fetch('/chats', { method: 'POST' })).json()) || [];
                },
            },
            menuShow:true,
            chatSettingShow:false,
            ProviderModel: "",//下拉菜单的绑定，服务端不用
            systemPrompt:"",//prompt
            userContent: {
                'x-ref': 'userContent',
                '@keydown.enter'(event) {
                    const textarea = this.$refs.userContent;
                    if (!event.shiftKey) {
                        event.preventDefault()
                        this.chat.data.messages.push({ content: textarea.value, role: "user" });
                        textarea.value = '';
                        this.postCompletion();
                    }
                },
            },
            async postCompletion(){
                let chatForm={
                    provider : this.ProviderModel.split(':')[0], // 冒号前的部分
                    model :this.ProviderModel.split(':').slice(1).join(':'),// 冒号后的部分
                    messages: this.chat.data.messages
                }
                const xs = XhrSource('/chat/completion', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body:  JSON.stringify(chatForm)
                });
                xs.addEventListener('open', () => {
                    this.chat.data.messages.push({content: '', role: "assistant"});
                });
                xs.addEventListener('message', e => {
                    // 获取当前messages中的最后一条消息
                    const messages = this.chat.messages;
                    const lastMessage = messages[messages.length - 1];
                    // 将接收到的数据追加到最后一条消息的content中
                    if (lastMessage && lastMessage.role === "assistant") {
                        lastMessage.content += JSON.parse(e.data);
                        // window.hljs.highlightAll();
                    }
                });
                xs.addEventListener('close', async e => {
                    //流式响应结束后在这put /chat
                    let res=await this.chat.put(this.chat.data)
                    history.replaceState(null, '', `/chat/${res.id}`);
                    console.log(`SSE connection closed,replaced history with ${res.id}`);
                    await this.postChats()
                });
            }
        }))
    })
</script>